---
version: 2.1

orbs:
  jq: circleci/jq@2.2.0
  node: circleci/node@5.1.0

commands:

  # Build docker image for testing
  build-docker-image:
    description: Build a docker image for the simple superhero service
    parameters:
      project_name:
        type: string
      dockerfile_path:
        type: string
    steps:
      - setup_remote_docker:
         docker_layer_caching: true
      - add_ssh_keys:
          fingerprints:
            - 93:a9:f3:d3:97:84:fe:e3:a2:63:9e:fe:3f:be:6e:73
      - run:
          name: verify
          command: printenv | sort
      - run:
          name: Build and tag docker image
          command: |
            docker build --no-cache --rm --tag ${DOCKER_IMAGE_TAG}  --build-arg NODE=14 -f << parameters.dockerfile_path >> .
            
  run-docker-container:
    description: "we've built the container, let's run it for tests"
    parameters:
      cors_origin:
        default: "*"
        type: string
      port:
        default: 3000
        type: integer
    steps:
      - setup_remote_docker:
         docker_layer_caching: true
      - run:
          name: docker run command
          command: |
            docker run --tty --detach --name ${CIRCLE_PROJECT_REPONAME} --network host -e cors_origin=<< parameters.cors_origin >> -e port=<< parameters.port >> ${DOCKER_IMAGE_TAG}

  setup-docker-build-environment:
    description: set the environment variables needed within the docker build environment in circleci
    steps:
      - jq/install
      - run:
          name: set the env var based on branch
          command: |
              DOCKER_IMAGE_VERSION=$(echo $(cat package.json) | jq -r '.version')
              DOCKER_IMAGE_TAG="${CIRCLE_PROJECT_REPONAME}:${DOCKER_IMAGE_VERSION}"
              
              case "$CIRCLE_BRANCH" in
                dev|develop)
                  echo "SETTING DEV ENVIRONMENT VARIABLES"
                  echo "export SOME_VAR_NAME='dev'" >> "$BASH_ENV"
                  ;;
                master)
                  eecho "SETTING MASTER ENVIRONMENT VARIABLES"
                  ;;
                *)
                  echo "NO ENV VAR SET - DEFAULTING"
                  echo "export DOCKER_IMAGE_TAG='${DOCKER_IMAGE_TAG}'" >> "$BASH_ENV"
                  ;;
              esac

  setup-sss-project:
    description: setup simple superhero service specific stuff
    steps:
      - run: 
          name: generate self signed certs
          command: openssl req -new -newkey rsa:4096 -x509 -sha256 -days 3650 -nodes -keyout sss-key.pem -out sss-cert.pem -subj "/C=US/ST=of Confusion/L=Gotham/O=/OU=/CN="

# ======================================== JOBS ========================================
jobs:
 
  build-sss:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup-docker-build-environment
      - setup-sss-project
      - build-docker-image:
          project_name: ${CIRCLE_PROJECT_REPONAME}
          dockerfile_path: ./Dockerfile

  run-sss-valid-origin-container:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup-docker-build-environment
      - node/install:
          node-version: "14"
      - node/install-packages
      - run-docker-container:
          cors_origin: "https://127.0.0.1:3100"
          port: 3000
  
  run-sss-invalid-origin-container:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup-docker-build-environment
      - node/install:
          node-version: "14"
      - node/install-packages
      - run-docker-container:
          cors_origin: "https://127.0.0.1:2111"
          port: 3001

  tests-cors:
    docker:
      - image: cypress/base:14
    steps:
      - checkout
      - node/install-packages
      - run:
          name: valid cors test
          command: NODE_ENV=cors-valid ./node_modules/.bin/cypress run --env sssApuUrl=https://127.0.0.1:3000
      - run:
          name: invalid cors test
          command: NODE_ENV=cors-invalid ./node_modules/.bin/cypress run --env sssApuUrl=https://127.0.0.1:3001

  tests-functional:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup-docker-build-environment
      - setup-sss-project
      - node/install:
          node-version: "14"
      - node/install-packages
      - run-docker-container:
          cors_origin: "[*]"
          port: 3000
      - run: 
          name: docker logs
          command: docker logs --follow --until=30s simple-superhero-service
      - run: 
          name: pull git submodules 
          command: git submodule update --init --recursive
      - run:
          name: list directory contents
          command: ls -al tests
      - run:
          name: list docker containers
          command: docker container ls
      - run:
          name: list docker images
          command: docker image ls
      - run:
          name: newman(postman) tests
          command: ./node_modules/.bin/newman run tests/tests/simple_super_hero_service.postman_collection.json --insecure --environment tests/tests/test.postman_environment.json
  
  tests-unit:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - node/install:
          node-version: "14"
      - node/install-packages
      - run:
          name: unit tests
          command: ./node_modules/.bin/jest

#======================================== WORKFLOWS ========================================
workflows:
  
  test-build:
    jobs:

      # =============================================
      # DEV CONFIG
      # =============================================
      - build-sss:
          filters:
            branches:
              ignore:
                - master
      
      # Setup a valid Origin Container (based on server configuration) to run run all the tests
      - run-sss-valid-origin-container:
          filters:
            branches:
              ignore:
                - master
          requires:
            - build-sss
      
      # Setup a invalid Origin Container (based on server configuration) to run CORS tests
      - run-sss-invalid-origin-container:
          filters:
            branches:
              ignore:
                - master
          requires:
            - build-sss
      
      # cors test sss
      - tests-cors:
          filters:
            branches:
              ignore:
                - master
          requires:
            - build-sss
            - run-sss-valid-origin-container
            - run-sss-invalid-origin-container

      - tests-unit:
          filters:
            branches:
              ignore:
                - master
          requires:
            - build-sss
            - run-sss-valid-origin-container

      - tests-functional:
          filters:
            branches:
              ignore:
                - master
          requires:
            - build-sss
            - run-sss-valid-origin-container

 